export const title = "Komodo DeFi Framework Method: Trade Preimage";
export const description = "The trade_preimage method returns the approximate fee amounts that are paid per the whole swap.";

# Trade Preimage

## trade\_preimage {{label : 'trade_preimage', tag : 'API-v2'}}

The `trade_preimage` method returns the approximate fee amounts that are paid per the whole swap.
Depending on the parameters, the function returns different results:

*   If the `swap_method` is `buy` or `sell`, then the result will include the `taker_fee` and the `fee_to_send_taker_fee`.
    The `taker_fee` amount is paid from the `base` coin balance if the `swap_method` is `sell`, else it is paid from the `rel` coin balance;
*   If the `max` field is true, then the result will include the `volume`.

<Note>
  This method can be used instead of **max\_taker\_vol**, if the `max` field is true and the `swap_method` is `buy` or `sell`.
  Use the resulting `volume` as an argument of the `buy` or `sell` requests.
</Note>

<Note type="warning">
  Use the `trade_preimage` request with `max = true` and `swap_method = "setprice"` arguments to approximate the fee amounts **only**. Do not use the resulting `volume` as an argument of the `setprice`.
</Note>

### Request Parameters

| Parameter    | Type                       | Required | Default | Description                                                                                                                                                                                 |
| ------------ | -------------------------- | :------: | :-----: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| base         | string                     |     ✓    |   `-`   | The base currency of the request.                                                                                                                                                           |
| rel          | string                     |     ✓    |   `-`   | The rel currency of the request.                                                                                                                                                            |
| swap\_method | string                     |     ✓    |   `-`   | The name of the method whose preimage is requested. Possible values: `buy`, `sell`, `setprice`. See [SwapMethodEnum](/komodo-defi-framework/api/common_structures/enums/#swap-method-enum). |
| price        | numeric string or rational |     ✓    |   `-`   | The price in `rel` the user is willing to pay per one unit of the `base` coin.                                                                                                              |
| max          | bool                       |     ✗    | `false` | Whether to return the maximum available volume for `setprice` method; must not be set or `false` if `swap_method` is `buy` or `sell`.                                                       |
| volume       | numeric string or rational |     ✗    |   `-`   | The amount the user is willing to trade; ignored if `max = true` **and** `swap_method = setprice`, otherwise, it must be set.                                                               |

### Response Parameters

| Parameter                 | Type             | Description                                                                                                                                                                                                                                            |
| ------------------------- | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| base\_coin\_fee           | object           | A standard [ExtendedFeeInfo](/komodo-defi-framework/api/common_structures/wallet/#extended-fee-info) object. The approximate miner fee is paid per the whole swap concerning the `base` coin.                                                          |
| rel\_coin\_fee            | object           | A standard [ExtendedFeeInfo](/komodo-defi-framework/api/common_structures/wallet/#extended-fee-info) object. The approximate miner fee is paid per the whole swap concerning the `rel` coin.                                                           |
| volume                    | string (numeric) | Optional. The max available volume that can be traded (in decimal representation); empty if the `max` argument is missing or false.                                                                                                                    |
| volume\_rat               | rational         | Optional. The max available volume that can be traded represented as a standard [RationalValue](/komodo-defi-framework/api/common_structures/#rational-value) object.; empty if the `max` argument is missing or false.                                |
| volume\_fraction          | fraction         | Optional. The max available volume that can be traded represented as a standard [fractionalValue](/komodo-defi-framework/api/common_structures/#fractional-value) object.; empty if the `max` argument is missing or false.                            |
| taker\_fee                | object           | A standard [ExtendedFeeInfo](/komodo-defi-framework/api/common_structures/wallet/#extended-fee-info) object. The dex fee to be paid by Taker; empty if `swap_method` is `setprice`.                                                                    |
| fee\_to\_send\_taker\_fee | object           | A standard [ExtendedFeeInfo](/komodo-defi-framework/api/common_structures/wallet/#extended-fee-info) object. The approximate miner fee is paid to send the dex fee; empty if `swap_method` is `setprice`.                                              |
| total\_fees               | array of objects | A standard [TotalFeeInfo](/komodo-defi-framework/api/common_structures/wallet/#total-fee-info) object. Each element is a sum of fees required to be paid from user's balance of corresponding `ExtendedFeeInfo.coin`; the elements are unique by coin. |

### 📌 Examples

#### Command (setprice)

<CodeGroup title="Trade Preimage (setprice)" tag="POST" label="trade_preimage" mm2MethodDecorate="true">
  ```json
  {
    "mmrpc": "2.0",
    "userpass": "RPC_UserP@SSW0RD",
    "method": "trade_preimage",
    "params": {
      "base": "BTC",
      "rel": "DOC",
      "price": "1",
      "volume": "0.1",
      "swap_method": "setprice"
    },
    "id": 0
  }
  ```
</CodeGroup>

<CollapsibleSection expandedText="Hide Trade Preimage (setprice) Response" collapsedText="Show Trade Preimage (setprice) Response">
  ```json
  {
    "mmrpc": "2.0",
    "result": {
      "base_coin_fee": {
        "coin": "KMD",
        "amount": "0.00001",
        "amount_fraction": {
          "numer": "1",
          "denom": "100000"
        },
        "amount_rat": [
          [1, [1]],
          [1, [100000]]
        ],
        "paid_from_trading_vol": false
      },
      "rel_coin_fee": {
        "coin": "DGB",
        "amount": "0.00030782",
        "amount_fraction": {
          "numer": "15391",
          "denom": "50000000"
        },
        "amount_rat": [
          [1, [15391]],
          [1, [50000000]]
        ],
        "paid_from_trading_vol": true
      },
      "volume": "1138.46868712",
      "volume_fraction": {
        "numer": "14230858589",
        "denom": "12500000"
      },
      "volume_rat": [
        [1, [1345956701, 3]],
        [1, [12500000]]
      ],
      "total_fees": [
        {
          "coin": "KMD",
          "amount": "0.00001",
          "amount_fraction": {
            "numer": "1",
            "denom": "100000"
          },
          "amount_rat": [
            [1, [1]],
            [1, [100000]]
          ],
          "required_balance": "0.00001",
          "required_balance_fraction": {
            "numer": "1",
            "denom": "100000"
          },
          "required_balance_rat": [
            [1, [1]],
            [1, [100000]]
          ]
        },
        {
          "coin": "DGB",
          "amount": "0.00030782",
          "amount_fraction": {
            "numer": "15391",
            "denom": "50000000"
          },
          "amount_rat": [
            [1, [15391]],
            [1, [50000000]]
          ],
          "required_balance": "0",
          "required_balance_fraction": {
            "numer": "0",
            "denom": "1"
          },
          "required_balance_rat": [
            [0, []],
            [1, [1]]
          ]
        }
      ]
    },
    "id": 0
  }
  ```
</CollapsibleSection>

#### Command (buy)

<CodeGroup title="Trade Preimage (buy)" tag="POST" label="trade_preimage" mm2MethodDecorate="true">
  ```json
  {
    "mmrpc": "2.0",
    "userpass": "RPC_UserP@SSW0RD",
    "method": "trade_preimage",
    "params": {
      "base": "BTC",
      "rel": "DOC",
      "price": "1",
      "volume": "0.1",
      "swap_method": "buy"
    },
    "id": 0
  }
  ```
</CodeGroup>

<CollapsibleSection expandedText="Hide Trade Preimage (buy) Response" collapsedText="Show Trade Preimage (buy) Response">
  ```json
  {
    "mmrpc": "2.0",
    "result": {
      "base_coin_fee": {
        "amount": "0.00042049",
        "amount_fraction": {
          "denom": "100000000",
          "numer": "42049"
        },
        "amount_rat": [
          [1, [42049]],
          [1, [100000000]]
        ],
        "coin": "BTC",
        "paid_from_trading_vol": true
      },
      "rel_coin_fee": {
        "amount": "0.0001",
        "amount_fraction": {
          "denom": "10000",
          "numer": "1"
        },
        "amount_rat": [
          [1, [1]],
          [1, [10000]]
        ],
        "coin": "DOC",
        "paid_from_trading_vol": false
      },
      "taker_fee": {
        "amount": "0.00012870012870012872",
        "amount_fraction": {
          "denom": "7770",
          "numer": "1"
        },
        "amount_rat": [
          [1, [1]],
          [1, [7770]]
        ],
        "coin": "DOC",
        "paid_from_trading_vol": false
      },
      "fee_to_send_taker_fee": {
        "amount": "0.0001",
        "amount_fraction": {
          "denom": "10000",
          "numer": "1"
        },
        "amount_rat": [
          [1, [1]],
          [1, [10000]]
        ],
        "coin": "DOC",
        "paid_from_trading_vol": false
      },
      "total_fees": [
        {
          "coin": "DOC",
          "amount": "0.001307001287001287001287001287001287001287001287001287001287001287001287001287001287001287001287001287",
          "amount_fraction": {
            "numer": "50777",
            "denom": "38850000"
          },
          "amount_rat": [
            [1, [50777]],
            [1, [38850000]]
          ],
          "required_balance": "0.001307001287001287001287001287001287001287001287001287001287001287001287001287001287001287001287001287",
          "required_balance_fraction": {
            "numer": "50777",
            "denom": "38850000"
          },
          "required_balance_rat": [
            [1, [50777]],
            [1, [38850000]]
          ]
        },
        {
          "coin": "tBTC",
          "amount": "0.00042049",
          "amount_fraction": {
            "denom": "100000000",
            "numer": "42049"
          },
          "amount_rat": [
            [1, [42049]],
            [1, [100000000]]
          ],
          "required_balance": "0",
          "required_balance_fraction": {
            "numer": "0",
            "denom": "1"
          },
          "required_balance_rat": [
            [0, []],
            [1, [1]]
          ]
        }
      ]
    },
    "id": 0
  }
  ```
</CollapsibleSection>

#### Command (sell, max)

<CodeGroup title="Trade Preimage (sell, max)" tag="POST" label="trade_preimage" mm2MethodDecorate="true">
  ```json
  {
    "mmrpc": "2.0",
    "userpass": "RPC_UserP@SSW0RD",
    "method": "trade_preimage",
    "params": {
      "base": "BTC",
      "rel": "DOC",
      "price": "1",
      "volume": "2.21363478",
      "swap_method": "sell"
    },
    "id": 0
  }
  ```
</CodeGroup>

<CollapsibleSection expandedText="Hide Trade Preimage (sell, max) Response" collapsedText="Show Trade Preimage (sell, max) Response">
  ```json
  {
    "mmrpc": "2.0",
    "result": {
      "base_coin_fee": {
        "amount": "0.00042049",
        "amount_fraction": {
          "denom": "100000000",
          "numer": "42049"
        },
        "amount_rat": [
          [1, [42049]],
          [1, [100000000]]
        ],
        "coin": "BTC",
        "paid_from_trading_vol": false
      },
      "rel_coin_fee": {
        "coin": "DOC",
        "amount": "0.00001",
        "amount_fraction": {
          "numer": "1",
          "denom": "100000"
        },
        "amount_rat": [
          [1, [1]],
          [1, [100000]]
        ],
        "paid_from_trading_vol": true
      },
      "taker_fee": {
        "amount": "0.0028489508108108107",
        "amount_fraction": {
          "denom": "1850000000",
          "numer": "5270559"
        },
        "amount_rat": [
          [1, [5270559]],
          [1, [1850000000]]
        ],
        "coin": "BTC",
        "paid_from_trading_vol": false
      },
      "fee_to_send_taker_fee": {
        "amount": "0.00033219",
        "amount_fraction": {
          "denom": "100000000",
          "numer": "33219"
        },
        "amount_rat": [
          [1, [33219]],
          [1, [100000000]]
        ],
        "coin": "BTC",
        "paid_from_trading_vol": false
      },
      "total_fees": [
        {
          "coin": "DOC",
          "amount": "0.00001",
          "amount_fraction": {
            "numer": "1",
            "denom": "100000"
          },
          "amount_rat": [
            [1, [1]],
            [1, [100000]]
          ],
          "required_balance": "0",
          "required_balance_fraction": {
            "numer": "0",
            "denom": "1"
          },
          "required_balance_rat": [
            [0, []],
            [1, [1]]
          ]
        },
        {
          "coin": "BTC",
          "amount": "0.0036016308108108106",
          "amount_fraction": {
            "denom": "1850000000",
            "numer": "6663017"
          },
          "amount_rat": [
            [1, [6663017]],
            [1, [1850000000]]
          ],
          "required_balance": "0.0036016308108108106",
          "required_balance_fraction": {
            "denom": "1850000000",
            "numer": "6663017"
          },
          "required_balance_rat": [
            [1, [6663017]],
            [1, [1850000000]]
          ]
        }
      ]
    },
    "id": 0
  }
  ```
</CollapsibleSection>

#### Command (ERC20 and QRC20)

<CodeGroup title="Trade Preimage (ERC20 and QRC20)" tag="POST" label="trade_preimage" mm2MethodDecorate="true">
  ```json
  {
    "mmrpc": "2.0",
    "userpass": "RPC_UserP@SSW0RD",
    "method": "trade_preimage",
    "params": {
      "base": "LTC",
      "rel": "LTC",
      "price": "1",
      "volume": "2.21363478",
      "swap_method": "setprice"
    },
    "id": 0
  }
  ```
</CodeGroup>

<CollapsibleSection expandedText="Hide Trade Preimage (ERC20 and QRC20) Response" collapsedText="Show Trade Preimage (ERC20 and QRC20) Response">
  ```json
  {
    "mmrpc": "2.0",
    "result": {
      "base_coin_fee": {
        "amount": "0.0045",
        "amount_fraction": {
          "denom": "2000",
          "numer": "9"
        },
        "amount_rat": [
          [1, [9]],
          [1, [2000]]
        ],
        "coin": "ETH",
        "paid_from_trading_vol": false
      },
      "rel_coin_fee": {
        "amount": "0.00325",
        "amount_fraction": {
          "denom": "4000",
          "numer": "13"
        },
        "amount_rat": [
          [0, [13]],
          [1, [4000]]
        ],
        "coin": "QTUM",
        "paid_from_trading_vol": false
      },
      "total_fees": [
        {
          "amount": "0.003",
          "amount_fraction": {
            "denom": "1000",
            "numer": "3"
          },
          "amount_rat": [
            [1, [3]],
            [1, [1000]]
          ],
          "required_balance": "0.003",
          "required_balance_fraction": {
            "denom": "1000",
            "numer": "3"
          },
          "required_balance_rat": [
            [1, [3]],
            [1, [1000]]
          ],
          "coin": "ETH"
        },
        {
          "amount": "0.00325",
          "amount_fraction": {
            "denom": "4000",
            "numer": "13"
          },
          "amount_rat": [
            [0, [13]],
            [1, [4000]]
          ],
          "required_balance": "0.00325",
          "required_balance_fraction": {
            "denom": "4000",
            "numer": "13"
          },
          "required_balance_rat": [
            [0, [13]],
            [1, [4000]]
          ],
          "coin": "QTUM"
        }
      ]
    },
    "id": 0
  }
  ```
</CollapsibleSection>

### ⚠️ Error Types

| Error                        | Description                                                                       |
| ---------------------------- | --------------------------------------------------------------------------------- |
| NotSufficientBalance         | The available balance of the coin is not sufficient to start the swap.            |
| NotSufficientBaseCoinBalance | The available balance of the base coin is not sufficient to pay transaction fees. |
| VolumeTooLow                 | The specified volume is too low. Required at least threshold.                     |
| NoSuchCoin                   | The specified coin was not found or is not activated yet.                         |
| CoinIsWalletOnly             | The specified coin is wallet only and cannot be participated in the swap.         |
| BaseEqualRel                 | The base and rel coins are the same.                                              |
| InvalidParam                 | Incorrect use of a parameter in the request.                                      |
| PriceTooLow                  | The specified price is too low.                                                   |
| Transport                    | The request failed due to a network error.                                        |
| InternalError                | The request failed due to a Komodo DeFi Framework API internal error.             |

<CollapsibleSection expandedText="Hide Error Responses" collapsedText="Show Error Responses">
  #### ⚠️ Error Responses

  ##### NotSufficientBalance

  ```json
  {
    "mmrpc": "2.0",
    "error": "Not enough balance",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:123]",
    "error_type": "NotSufficientBalance",
    "error_data": {
      "coin": "BTC",
      "available": "0.5",,
      "locked_by_swaps": "0"
      "required": "1.0"
    },
    "id": null
  }
  ```

  ##### NotSufficientBaseCoinBalance

  ```json
  {
    "mmrpc": "2.0",
    "error": "Not enough base coin balance",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:456]",
    "error_type": "NotSufficientBaseCoinBalance",
    "error_data": {
      "coin": "ETH",
      "available": "0.1",
      "required": "0.2"
    },
    "id": 0
  }
  ```

  ##### VolumeTooLow

  ```json
  {
    "mmrpc": "2.0",
    "error": "Volume too low",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:789]",
    "error_type": "VolumeTooLow",
    "error_data": {
      "coin": "BTC",
      "volume": "0.01",
      "threshold": "0.1"
    },
    "id": null
  }
  ```

  ##### NoSuchCoin

  ```json
  {
    "mmrpc": "2.0",
    "error": "No such coin",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:1011]",
    "error_type": "NoSuchCoin",
    "error_data": {
      "coin": "XYZ"
    },
    "id": null
  }
  ```

  ##### CoinIsWalletOnly

  ```json
  {
    "mmrpc": "2.0",
    "error": "Coin is wallet only",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:1213]",
    "error_type": "CoinIsWalletOnly",
    "error_data": {
      "coin": "WALLET"
    },
    "id": null
  }
  ```

  ##### BaseEqualRel

  ```json
  {
    "mmrpc": "2.0",
    "error": "Base and rel coins are the same",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:1415]",
    "error_type": "BaseEqualRel",
    "id": null
  }
  ```

  ##### InvalidParam

  ```json
  {
    "mmrpc": "2.0",
    "error": "Invalid parameter",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:1617]",
    "error_type": "InvalidParam",
    "error_data": {
      "param": "price",
      "reason": "Price must be greater than zero"
    },
    "id": null
  }
  ```

  ##### PriceTooLow

  ```json
  {
    "mmrpc": "2.0",
    "error": "Price too low",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:1819]",
    "error_type": "PriceTooLow",
    "error_data": {
      "price": "0.0001",
      "threshold": "0.001"
    },
    "id": null
  }
  ```

  ##### Transport

  ```json
  {
    "mmrpc": "2.0",
    "error": "Transport error",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:2021]",
    "error_type": "Transport",
    "error_data": "Network timeout"
  }
  ```

  ##### InternalError

  ```json
  {
    "mmrpc": "2.0",
    "error": "Internal error",
    "error_path": "trade_preimage",
    "error_trace": "trade_preimage:2223]",
    "error_type": "InternalError",
    "error_data": "Unexpected server error"
  }
  ```
</CollapsibleSection>
