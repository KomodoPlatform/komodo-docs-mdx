export const title = "Komodo DeFi Framework Metrics";
export const description =
  "Monitor and analyze the performance and activity of your Komodo DeFi Framework API sessions with various metrics.";

import prometheus1 from "@/public/images/docs/komodo-defi-framework-tutorials/prometheus1.png";
import graphana1 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana1.png";
import graphana2 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana2.png";
import graphana3 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana3.png";
import graphana4 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana4.png";
import graphana5 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana5.png";
import graphana6 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana6.png";
import graphana7 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana7.png";
import graphana8 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana8.png";
import graphana9 from "@/public/images/docs/komodo-defi-framework-tutorials/graphana9.png";

# Komodo DeFi Framework Metrics

The Komodo DeFi Framework  collects data metrics that allow interested users to view a history of events of an Komodo DeFi Framework API session, such as incoming and outgoing traffic.

The metrics can be:

*   Recorded to a log file at a specified frequency
*   Requested using Komodo DeFi Framework API in JSON format
*   Visualized using Prometheus and Grafana

## Setting Up Log Recording

By default, collected metrics are recorded to a log file every five minutes, but this value can be defined with the `metrics` parameter in a user's [MM2.json file](/komodo-defi-framework/setup/configure-mm2-json/).

```bash
"metrics\": 0,
```

To disable the collection of metrics, set the `metrics` parameter to 0.

### Requesting Metrics Manually

Execute the following command to request a metrics snapshot.

<CodeGroup title="" tag="POST" label="metrics" mm2MethodDecorate="true">
  ```json
  {
    "method": "metrics",
    "userpass": "RPC_UserP@SSW0RD"
  }
  ```
</CodeGroup>

<CollapsibleSection expandedText="Hide Response" collapsedText="Show Response">
  ```json
  {
    "metrics": [
      {
        "type": "counter",
        "key": "tx.history.response.count",
        "labels": {
          "coin": "MARTY",
          "method": "tx_detail_by_hash"
        },
        "value": 25
      },
      {
        "type": "counter",
        "key": "rpc_client.request.count",
        "labels": {
          "client": "electrum",
          "coin": "DOC"
        },
        "value": 1224
      },
      {
        "type": "counter",
        "key": "tx.history.response.count",
        "labels": {
          "method": "tx_detail_by_hash",
          "coin": "DOC"
        },
        "value": 27
      },
      {
        "type": "counter",
        "key": "tx.history.request.count",
        "labels": {
          "coin": "DOC",
          "method": "tx_detail_by_hash"
        },
        "value": 27
      },
      {
        "type": "counter",
        "key": "rpc_client.traffic.in",
        "labels": {
          "client": "electrum",
          "coin": "DOC"
        },
        "value": 823841
      },
      {
        "type": "counter",
        "key": "rpc_client.traffic.out",
        "labels": {
          "coin": "MARTY",
          "client": "electrum"
        },
        "value": 139396
      },
      {
        "type": "counter",
        "key": "tx.history.response.total_length",
        "labels": {
          "client": "electrum",
          "coin": "MARTY",
          "method": "blockchain.scripthash.get_history"
        },
        "value": 1041
      },
      {
        "type": "counter",
        "key": "tx.history.response.count",
        "labels": {
          "client": "electrum",
          "coin": "MARTY",
          "method": "blockchain.scripthash.get_history"
        },
        "value": 11
      },
      {
        "type": "counter",
        "key": "tx.history.response.count",
        "labels": {
          "method": "blockchain.scripthash.get_history",
          "client": "electrum",
          "coin": "DOC"
        },
        "value": 6
      },
      {
        "type": "counter",
        "key": "tx.history.request.count",
        "labels": {
          "coin": "MARTY",
          "method": "tx_detail_by_hash"
        },
        "value": 25
      },
      {
        "type": "counter",
        "key": "rpc_client.response.count",
        "labels": {
          "coin": "DOC",
          "client": "electrum"
        },
        "value": 1351
      },
      {
        "type": "counter",
        "key": "rpc_client.request.count",
        "labels": {
          "client": "electrum",
          "coin": "MARTY"
        },
        "value": 1237
      },
      {
        "type": "counter",
        "key": "rpc_client.traffic.in",
        "labels": {
          "client": "electrum",
          "coin": "MARTY"
        },
        "value": 772964
      },
      {
        "type": "counter",
        "key": "tx.history.response.total_length",
        "labels": {
          "coin": "DOC",
          "client": "electrum",
          "method": "blockchain.scripthash.get_history"
        },
        "value": 767
      },
      {
        "type": "counter",
        "key": "tx.history.request.count",
        "labels": {
          "coin": "DOC",
          "client": "electrum",
          "method": "blockchain.scripthash.get_history"
        },
        "value": 6
      },
      {
        "type": "counter",
        "key": "rpc_client.traffic.out",
        "labels": {
          "coin": "DOC",
          "client": "electrum"
        },
        "value": 136368
      },
      {
        "type": "counter",
        "key": "tx.history.request.count",
        "labels": {
          "coin": "MARTY",
          "client": "electrum",
          "method": "blockchain.scripthash.get_history"
        },
        "value": 11
      },
      {
        "type": "counter",
        "key": "rpc_client.response.count",
        "labels": {
          "client": "electrum",
          "coin": "MARTY"
        },
        "value": 1361
      },
      {
        "type": "gauge",
        "key": "p2p.connected_peers.count",
        "labels": {},
        "value": 8.0
      },
      {
        "type": "gauge",
        "key": "p2p.received_messages.count",
        "labels": {},
        "value": 24.0
      },
      {
        "type": "gauge",
        "key": "p2p.connected_relays.len",
        "labels": {},
        "value": 8.0
      },
      {
        "type": "gauge",
        "key": "p2p.relay_mesh.len",
        "labels": {},
        "value": 2.0
      },
      {
        "type": "gauge",
        "key": "orderbook.memory_db",
        "labels": {},
        "value": 297800390224.0
      },
      {
        "type": "gauge",
        "key": "orderbook.len",
        "labels": {},
        "value": 15.0
      },
      {
        "type": "gauge",
        "key": "p2p.received_messages.period_in_secs",
        "labels": {},
        "value": 60.0
      },
      {
        "type": "histogram",
        "key": "peer.outgoing_request.timing",
        "labels": {
          "peer": "12D3KooWJDoV9vJdy6PnzwVETZ3fWGMhV41VhSbocR1h2geFqq9Y"
        },
        "count": 2.0,
        "max": 0.801318629,
        "min": 0.699428848
      }
    ]
  }
  ```
</CollapsibleSection>

## Prometheus Integration

Komodo DeFi Framework API 2.0 supports integration with [Prometheus](https://github.com/prometheus/prometheus#install). This software allows users to setup automated scraping of metrics at regular intervals and enables sophisticated queries on the stored [timeseries](https://en.wikipedia.org/wiki/Time_series) data. It also allows users to configure an elegant dashboard using built-in [graphs,](https://prometheus.io/docs/prometheus/latest/getting_started/#using-the-expression-browser) or to export data for graphical processing using [Grafana](https://prometheus.io/docs/visualization/grafana/).

Prometheus scrapes metrics using an HTTP pull model. To provide Prometheus with the ability to scrape the metrics at [localhost:9001](http://localhost:9001), you need to add the `prometheusport` parameter to your [MM2.json file](/komodo-defi-framework/setup/configure-mm2-json/):

```bash
"prometheusport": 9001
```

You can also define your username and password for Prometheus to enforce basic authorization security with the `prometheus_credentials` in your [MM2.json file](/komodo-defi-framework/setup/configure-mm2-json/). Note that this additional argument is NOT necessary.

```bash
"prometheus_credentials": "PROM_USERNAME:PROM_PASSWORD"
```

Replace `PROM_USERNAME` and `PROM_PASSWORD` with your actual Prometheus username and password. Make sure your username and password are separated by `:`.

### Configuring Prometheus to monitor the Komodo DeFi Framework API

The following basic Prometheus configuration file, named `prometheus.yml`, can simplify the process of connecting Prometheus to the Komodo DeFi Framework API.

```yaml
global:
  scrape_interval: 10s

scrape_configs:
  - job_name: "KomoDeFi_API"

    basic_auth:
      username: "PROM_USERNAME"
      password: "PROM_PASSWORD"

    static_configs:
      - targets: ["0.0.0.0:9001"]
        labels:
          group: "komodefi"
```

Replace `PROM_USERNAME` and `PROM_PASSWORD` with your actual Prometheus username and password.

To learn more about creating a Prometheus configuration file, [read this documentation.](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)

### Starting Prometheus and Grafana

A simple way to initiate Prometheus and Grafana is to have the standard Prometheus and Grafana [docker containers](https://www.infoworld.com/article/3310941/why-you-should-use-docker-and-containers.html) run together using `docker-compose`.

Name the following compose file as `docker-compose.yml`.

```yaml
version: "3.1"
volumes:
  prometheus:
  grafana:
services:
  grafana:
    image: grafana/grafana:latest
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
    network_mode: "host"
    volumes:
      - grafana:/var/lib/grafana
    restart: always
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    network_mode: "host"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus:/prometheus
    restart: always
```

Use the following command to start both containers.

```bash
docker-compose up
```

### Using the graphing interface

#### Prometheus

Once the docker containers are up and running, navigate to [http://localhost:9090/graph](http://localhost:9090/graph) and use the `Graph` tab to use Prometheus's built-in graph expressions.

To visualize one of the available metrics, open the metric explorer (next to the execute button), select a metric and then click execute.

<OptimizedImage title="Prometheus" src={prometheus1} classNaming="w-full" alt="Prometheus" />

More graphs can be added to the same page using the "Add Panel" button available.

#### Grafana

Grafana can access data scraped by Prometheus and it can analyze, transform and display it in a variety of ways. For more information see the [Prometheus guide.](https://prometheus.io/docs/visualization/grafana/#using)

To use Grafana, navigate to [http://localhost:3000](http://localhost:3000) and log in using the default credentials: `admin` / `admin`. When offered to set a new password, do so and secure it in an encrypted password manager like [KeePassXC](https://keepassxc.org/).

Next we need to add Prometheus as a data source. Click on the cog icon in the sidebar to open the configuration panel.

<OptimizedImage title="Grafana" src={graphana1} classNaming="w-full" alt="Grafana" />

Click the "Add data source" button, and select **Prometheus** from the menu. Set the URL to `http://localhost:9090`, leave other fields as default, and click the "Test and save" button at the bottom of the form.

<OptimizedImage title="Grafana" src={graphana2} classNaming="w-full" alt="Grafana" />

Next, navigate to [http://localhost:3000/dashboards](http://localhost:3000/dashboards) and click on the `New Dashboard` button

<OptimizedImage title="Grafana" src={graphana3} classNaming="w-full" alt="Grafana" />

Next, click on `Add a new panel`

<OptimizedImage title="Grafana" src={graphana4} classNaming="w-full" alt="Grafana" />

In the next screen, select `Prometheus` as the provider from the drop down menu in the `Query` tab.

<OptimizedImage title="Grafana" src={graphana5} classNaming="w-full" alt="Grafana" />

Click the `Metrics` menu and select one of the available options. These should be the same ones available directly in the Graphs tab of Prometheus: [http://localhost:9090/graph](http://localhost:9090/graph).

<OptimizedImage title="Grafana" src={graphana6} classNaming="w-full" alt="Grafana" />

Optionally, you can tweak the query options (shown in the image below).

<OptimizedImage title="Grafana" src={graphana7} classNaming="w-full" alt="Grafana" />

Once complete, click on `Run queries` to see the data displayed on the graph. If you like, you can also customise the graph, by adding a title, changing the colors, or using a different graph type. Click `Apply` in the top right corner once complete.

<OptimizedImage title="Grafana" src={graphana8} classNaming="w-full" alt="Grafana" />

Add any additional panels as desired, and save them to your dashboard.

<OptimizedImage title="Grafana" src={graphana9} classNaming="w-full" alt="Grafana" />
